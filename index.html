<!DOCTYPE html>
<html>
<head>
    <title>Eternal Empire - Fixed Version</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            color: white;
            background: #000;
        }
        
        /* Bigger Login Screen */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #001144 0%, #000022 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .login-box {
            background: rgba(0, 30, 60, 0.95);
            padding: 40px;
            border-radius: 25px;
            border: 4px solid #00aaff;
            box-shadow: 0 0 60px rgba(0, 170, 255, 0.6);
            text-align: center;
            width: 100%;
            max-width: 600px;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .game-title {
            color: #00ffff;
            font-size: 56px;
            margin-bottom: 15px;
            text-shadow: 0 0 30px #00ffff;
            letter-spacing: 3px;
            font-weight: bold;
        }
        
        .game-subtitle {
            color: #88ccff;
            font-size: 22px;
            margin-bottom: 40px;
        }
        
        .login-input {
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            background: rgba(0, 40, 80, 0.8);
            border: 3px solid #0088ff;
            border-radius: 15px;
            color: white;
            font-size: 20px;
            font-size: clamp(18px, 5vw, 22px);
            text-align: center;
        }
        
        /* EXTRA BIG BUTTONS */
        .login-btn {
            width: 100%;
            padding: 25px;
            margin: 20px 0;
            background: linear-gradient(45deg, #0088ff, #00ccff);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-btn:active {
            transform: scale(0.95);
            background: linear-gradient(45deg, #00ccff, #00ffff);
            box-shadow: 0 0 40px #00ffff;
        }
        
        .rulebook-btn {
            background: linear-gradient(45deg, #ff8800, #ffaa00);
            border: 3px solid #ffaa00;
            font-size: 26px;
            min-height: 70px;
        }
        
        /* Game Container */
        #gameContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        /* EXTRA BIG Top Bar */
        #topBar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: rgba(0, 10, 30, 0.95);
            border-bottom: 3px solid #00aaff;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            gap: 15px;
            min-height: 90px;
        }
        
        .resource-display {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            flex: 1;
        }
        
        .resource-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 40, 80, 0.8);
            padding: 12px 20px;
            border-radius: 20px;
            border: 2px solid #00aaff;
            min-width: 140px;
        }
        
        .resource-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
        
        .resource-value {
            font-size: 22px;
            font-weight: bold;
            color: #00ffff;
            min-width: 60px;
            text-align: right;
        }
        
        /* EXTRA BIG Mobile Controls */
        #mobileControls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 180px;
            z-index: 50;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom, 20px));
        }
        
        .joystick-area {
            width: 150px;
            height: 150px;
            pointer-events: auto;
            position: relative;
        }
        
        .joystick-base {
            width: 140px;
            height: 140px;
            background: rgba(0, 30, 60, 0.9);
            border: 4px solid #00aaff;
            border-radius: 50%;
            position: absolute;
            bottom: 0;
            left: 0;
        }
        
        .joystick-thumb {
            width: 70px;
            height: 70px;
            background: rgba(0, 170, 255, 0.95);
            border: 4px solid #00ffff;
            border-radius: 50%;
            position: absolute;
            bottom: 35px;
            left: 35px;
            transition: transform 0.1s;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: auto;
        }
        
        /* EXTRA BIG Action Buttons */
        .mobile-btn {
            width: 90px;
            height: 90px;
            background: rgba(0, 80, 160, 0.95);
            border: 4px solid #00aaff;
            border-radius: 50%;
            color: white;
            font-size: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
        }
        
        .mobile-btn:active {
            background: rgba(0, 150, 255, 0.95);
            transform: scale(0.9);
            box-shadow: 0 0 30px #00ffff;
        }
        
        /* EXTRA BIG Action Bar */
        #mobileActionBar {
            position: absolute;
            bottom: 200px;
            left: 0;
            width: 100%;
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 50;
            flex-wrap: wrap;
        }
        
        .action-bar-btn {
            padding: 20px 30px;
            background: rgba(0, 60, 120, 0.95);
            border: 3px solid #00cc88;
            border-radius: 30px;
            color: white;
            font-size: 22px;
            cursor: pointer;
            min-width: 120px;
            text-align: center;
            transition: all 0.1s;
        }
        
        .action-bar-btn:active {
            background: rgba(0, 150, 200, 0.95);
            transform: scale(0.95);
            box-shadow: 0 0 30px #00ff88;
        }
        
        /* Canvas - Ensure it's visible */
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000022;
            display: block !important;
        }
        
        /* Big Notification */
        #mobileNotification {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 25px 35px;
            border-radius: 20px;
            border: 4px solid #00ff88;
            color: #00ff88;
            font-size: 20px;
            display: none;
            z-index: 1000;
            text-align: center;
            max-width: 90%;
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        /* Big Menu Button */
        #mobileMenuBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: rgba(0, 60, 120, 0.95);
            border: 3px solid #00aaff;
            border-radius: 50%;
            color: white;
            font-size: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 150;
            cursor: pointer;
        }
        
        /* Menu */
        #mobileMenu {
            position: absolute;
            top: 0;
            right: -350px;
            width: 320px;
            height: 100%;
            background: rgba(0, 30, 60, 0.98);
            border-left: 4px solid #00ccff;
            z-index: 200;
            transition: right 0.3s;
            padding: 25px;
            overflow-y: auto;
            padding-top: 100px;
        }
        
        .menu-item {
            padding: 25px;
            margin: 15px 0;
            background: rgba(0, 60, 120, 0.7);
            border: 2px solid #0088ff;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 20px;
            text-align: center;
        }
        
        .menu-item:active {
            background: rgba(0, 120, 240, 0.8);
            transform: translateX(-10px);
        }
        
        /* Loading Message */
        #loadingMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ffff;
            font-size: 24px;
            text-align: center;
            z-index: 9999;
            display: none;
        }
        
        /* Graphics Warning */
        #graphicsWarning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 30px;
            border-radius: 20px;
            border: 4px solid #ffaa00;
            color: #ffaa00;
            font-size: 20px;
            text-align: center;
            max-width: 90%;
            z-index: 9999;
            display: none;
        }
        
        /* Simple Crosshair */
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ffff;
            font-size: 40px;
            text-shadow: 0 0 20px #00ffff;
            z-index: 10;
            pointer-events: none;
        }
        
        /* Force Landscape */
        #orientationWarning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            text-align: center;
            padding: 20px;
        }
        
        /* Media Queries for Extra Small Screens */
        @media (max-height: 700px) {
            .login-box {
                padding: 30px;
                min-height: 400px;
            }
            
            .game-title {
                font-size: 44px;
            }
            
            .login-btn {
                padding: 20px;
                min-height: 70px;
                font-size: 24px;
            }
            
            .mobile-btn {
                width: 80px;
                height: 80px;
                font-size: 32px;
            }
            
            .joystick-area {
                width: 130px;
                height: 130px;
            }
            
            .joystick-base {
                width: 120px;
                height: 120px;
            }
            
            .joystick-thumb {
                width: 60px;
                height: 60px;
                bottom: 30px;
                left: 30px;
            }
        }
        
        @media (max-width: 480px) {
            .resource-item {
                min-width: 120px;
                padding: 10px 15px;
                font-size: 16px;
            }
            
            .resource-value {
                font-size: 18px;
            }
            
            .action-bar-btn {
                padding: 18px 25px;
                font-size: 18px;
                min-width: 100px;
            }
            
            .mobile-btn {
                width: 75px;
                height: 75px;
                font-size: 28px;
            }
        }
        
        /* Animation for notifications */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }
        
        .notification-animate {
            animation: fadeInOut 3s ease-in-out forwards;
        }
    </style>
</head>
<body>

<!-- Loading Message -->
<div id="loadingMessage">üîÑ Loading Eternal Empire...</div>

<!-- Graphics Warning -->
<div id="graphicsWarning">
    ‚ö†Ô∏è Graphics initialization failed.<br>
    Please refresh the page or check browser support.
</div>

<!-- Orientation Warning -->
<div id="orientationWarning">
    <div style="color: #00ffff; font-size: 28px; max-width: 400px; line-height: 1.5;">
        üì± Please rotate your device to landscape mode<br>
        for the best gaming experience!
        <div style="font-size: 100px; margin: 20px 0;">üîÑ</div>
        <button onclick="forceLandscape()" style="padding: 15px 30px; background: #00aaff; border: none; color: white; border-radius: 15px; font-size: 20px; margin-top: 20px;">
            Continue Anyway
        </button>
    </div>
</div>

<!-- Login Screen -->
<div id="loginScreen">
    <div class="login-box">
        <div class="game-title">ETERNAL EMPIRE</div>
        <div class="game-subtitle">Touch to Play ‚Ä¢ Build Your Galaxy</div>
        
        <input type="text" id="username" class="login-input" placeholder="COMMANDER NAME" maxlength="15">
        
        <button class="login-btn" onclick="startGame()">
            üöÄ START GAME
        </button>
        <button class="login-btn rulebook-btn" onclick="showQuickGuide()">
            üìñ QUICK GUIDE
        </button>
        
        <div style="margin-top: 30px; color: #88aaff; font-size: 16px;">
            Tap buttons ‚Ä¢ Drag joystick ‚Ä¢ Collect resources
        </div>
    </div>
</div>

<!-- Game Container -->
<div id="gameContainer">
    <!-- Top Bar -->
    <div id="topBar">
        <div class="resource-display">
            <div class="resource-item">
                <div class="resource-icon" style="background: #ffaa00;"></div>
                <div>IRON: <span class="resource-value" id="ironCount">0</span></div>
            </div>
            <div class="resource-item">
                <div class="resource-icon" style="background: #ff5555;"></div>
                <div>VOLCANIUM: <span class="resource-value" id="volcaniumCount">0</span></div>
            </div>
            <div class="resource-item">
                <div class="resource-icon" style="background: #00ff88;"></div>
                <div>ENERGY: <span class="resource-value" id="energyCount">100</span></div>
            </div>
        </div>
    </div>
    
    <!-- Crosshair -->
    <div id="crosshair">+</div>
    
    <!-- Big Menu Button -->
    <div id="mobileMenuBtn" onclick="toggleMobileMenu()">‚ò∞</div>
    
    <!-- Mobile Menu -->
    <div id="mobileMenu">
        <div class="menu-item" onclick="toggleMiningMode()">
            ‚õèÔ∏è MINING MODE: <span id="menuMiningStatus">OFF</span>
        </div>
        <div class="menu-item" onclick="enterShip()">
            üöÄ ENTER SPACESHIP
        </div>
        <div class="menu-item" onclick="showBuildMenu()">
            üèóÔ∏è BUILD MENU
        </div>
        <div class="menu-item" onclick="showGalaxyMap()">
            üåå GALAXY MAP
        </div>
        <div class="menu-item" onclick="saveGame()">
            üíæ SAVE GAME
        </div>
        <div class="menu-item" onclick="showQuickGuide()">
            üìñ QUICK GUIDE
        </div>
        <div class="menu-item" onclick="resetGame()" style="background: rgba(255,50,50,0.3);">
            üîÑ RESTART GAME
        </div>
        <div class="menu-item" onclick="toggleMobileMenu()" style="background: rgba(0,0,0,0.5);">
            ‚úï CLOSE MENU
        </div>
    </div>
    
    <!-- Big Action Bar -->
    <div id="mobileActionBar">
        <div class="action-bar-btn" onclick="toggleMiningMode()" id="mobileMiningBtn">
            ‚õèÔ∏è MINE
        </div>
        <div class="action-bar-btn" onclick="enterShip()">
            üöÄ SHIP
        </div>
        <div class="action-bar-btn" onclick="showBuildMenu()">
            üèóÔ∏è BUILD
        </div>
        <div class="action-bar-btn" onclick="collectAllResources()">
            ‚≠ê COLLECT
        </div>
    </div>
    
    <!-- Big Mobile Controls -->
    <div id="mobileControls">
        <div class="joystick-area" id="joystickArea">
            <div class="joystick-base"></div>
            <div class="joystick-thumb" id="joystickThumb"></div>
        </div>
        
        <div class="action-buttons">
            <div class="mobile-btn" id="jumpBtn" ontouchstart="mobileJump()" ontouchend="clearJump()">
                ‚¨ÜÔ∏è
            </div>
            <div class="mobile-btn" id="mineBtn" ontouchstart="mobileMine()">
                ‚õèÔ∏è
            </div>
            <div class="mobile-btn" id="actionBtn" ontouchstart="mobileAction()">
                ‚≠ê
            </div>
        </div>
    </div>
    
    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>
    
    <!-- Notification -->
    <div id="mobileNotification"></div>
</div>

<script>
// ======================
// FIXED GAME STATE
// ======================
let player = {
    name: 'Commander',
    resources: {
        iron: 0,
        volcanium: 0,
        energy: 100
    },
    level: 1,
    miningMode: false,
    position: { x: 0, y: 0, z: 0 }
};

// ======================
// TOUCH CONTROLS STATE
// ======================
let joystickActive = false;
let joystickOrigin = { x: 0, y: 0 };
let joystickPosition = { x: 0, y: 0 };
let touchMove = { x: 0, z: 0 };
let isJumping = false;

// ======================
// THREE.JS VARIABLES
// ======================
let scene, camera, renderer, controls;
let playerModel, terrain, spaceship;
let resourceNodes = [];
let isWebGLAvailable = true;

// ======================
// MOBILE UI FUNCTIONS
// ======================
function showNotification(text, duration = 3000) {
    const notification = document.getElementById('mobileNotification');
    notification.textContent = text;
    notification.style.display = 'block';
    notification.classList.remove('notification-animate');
    setTimeout(() => {
        notification.classList.add('notification-animate');
        setTimeout(() => {
            notification.style.display = 'none';
        }, duration);
    }, 10);
}

function toggleMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    if (menu.style.right === '0px') {
        menu.style.right = '-350px';
    } else {
        menu.style.right = '0px';
    }
}

function updateUI() {
    document.getElementById('ironCount').textContent = player.resources.iron;
    document.getElementById('volcaniumCount').textContent = player.resources.volcanium;
    document.getElementById('energyCount').textContent = Math.floor(player.resources.energy);
    document.getElementById('menuMiningStatus').textContent = player.miningMode ? 'ON' : 'OFF';
    
    const miningBtn = document.getElementById('mobileMiningBtn');
    if (player.miningMode) {
        miningBtn.style.background = 'rgba(0, 255, 100, 0.95)';
        miningBtn.style.borderColor = '#00ff00';
        miningBtn.style.boxShadow = '0 0 20px #00ff00';
    } else {
        miningBtn.style.background = 'rgba(0, 60, 120, 0.95)';
        miningBtn.style.borderColor = '#00cc88';
        miningBtn.style.boxShadow = 'none';
    }
}

function showQuickGuide() {
    showNotification(`
    üéÆ QUICK GUIDE:
    
    1. Left joystick ‚Üí Move
    2. Tap MINE button ‚Üí Toggle mining
    3. Walk to glowing rocks
    4. Rocks auto-mine when close
    5. Collect 50 Iron for ship
    6. Tap SHIP to enter
    7. Menu (‚ò∞) for more options
    `, 8000);
}

// ======================
// TOUCH CONTROLS - SIMPLIFIED
// ======================
function initTouchControls() {
    const joystickArea = document.getElementById('joystickArea');
    const joystickThumb = document.getElementById('joystickThumb');
    
    // Touch start
    joystickArea.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = joystickArea.getBoundingClientRect();
        
        joystickOrigin.x = rect.left + 75;
        joystickOrigin.y = rect.top + 75;
        joystickActive = true;
        
        updateJoystickPosition(touch.clientX, touch.clientY);
    });
    
    // Touch move
    document.addEventListener('touchmove', (e) => {
        if (!joystickActive) return;
        e.preventDefault();
        
        const touch = e.touches[0];
        updateJoystickPosition(touch.clientX, touch.clientY);
    });
    
    // Touch end
    document.addEventListener('touchend', () => {
        if (joystickActive) {
            joystickActive = false;
            joystickThumb.style.transform = 'translate(0, 0)';
            touchMove.x = 0;
            touchMove.z = 0;
        }
    });
    
    // Tap detection for mining
    renderer.domElement.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1 && player.miningMode) {
            checkMiningTap(e.touches[0]);
        }
    }, { passive: true });
}

function updateJoystickPosition(x, y) {
    const joystickThumb = document.getElementById('joystickThumb');
    const maxDistance = 50;
    
    let deltaX = x - joystickOrigin.x;
    let deltaY = y - joystickOrigin.y;
    
    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    if (distance > maxDistance) {
        deltaX = (deltaX / distance) * maxDistance;
        deltaY = (deltaY / distance) * maxDistance;
    }
    
    joystickThumb.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
    
    touchMove.x = deltaX / maxDistance;
    touchMove.z = -deltaY / maxDistance;
}

function checkMiningTap(touch) {
    const x = (touch.clientX / window.innerWidth) * 2 - 1;
    const y = -(touch.clientY / window.innerHeight) * 2 + 1;
    
    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(new THREE.Vector2(x, y), camera);
    
    resourceNodes.forEach((node, index) => {
        if (node.collected) return;
        
        const intersects = raycaster.intersectObject(node.mesh);
        if (intersects.length > 0) {
            mineResource(node, index);
        }
    });
}

// ======================
// GAME ACTIONS - SIMPLIFIED
// ======================
function mobileJump() {
    if (playerModel && !isJumping) {
        isJumping = true;
        playerModel.position.y = 5;
        showNotification("Jump!");
        setTimeout(() => {
            if (playerModel) playerModel.position.y = 1.5;
            isJumping = false;
        }, 500);
    }
}

function clearJump() {
    // Handle touch end for jump
}

function mobileMine() {
    toggleMiningMode();
}

function mobileAction() {
    if (player.miningMode) {
        // Try to mine nearest resource
        mineNearestResource();
    } else {
        showNotification("Turn on mining mode first!");
    }
}

function toggleMiningMode() {
    player.miningMode = !player.miningMode;
    updateUI();
    
    if (player.miningMode) {
        showNotification("‚õèÔ∏è MINING MODE ON\nWalk near rocks or tap them!");
    } else {
        showNotification("‚õèÔ∏è Mining mode off");
    }
}

function mineNearestResource() {
    if (!playerModel || resourceNodes.length === 0) return;
    
    let nearestNode = null;
    let nearestDistance = Infinity;
    
    resourceNodes.forEach((node, index) => {
        if (node.collected) return;
        
        const distance = playerModel.position.distanceTo(node.mesh.position);
        if (distance < 10 && distance < nearestDistance) {
            nearestDistance = distance;
            nearestNode = { node, index };
        }
    });
    
    if (nearestNode) {
        mineResource(nearestNode.node, nearestNode.index);
    } else {
        showNotification("No resources nearby!");
    }
}

function collectAllResources() {
    if (resourceNodes.length === 0) {
        showNotification("No resources to collect!");
        return;
    }
    
    let collected = 0;
    resourceNodes.forEach((node, index) => {
        if (!node.collected && playerModel.position.distanceTo(node.mesh.position) < 15) {
            mineResource(node, index);
            collected++;
        }
    });
    
    if (collected > 0) {
        showNotification(`Collected ${collected} resources!`);
    } else {
        showNotification("Walk closer to resources!");
    }
}

function enterShip() {
    if (player.resources.iron >= 50) {
        player.resources.iron -= 50;
        updateUI();
        showNotification("üöÄ ENTERING SHIP!\nFuel: 50 Iron\nNext: Build more ships!", 4000);
    } else {
        showNotification(`Need 50 Iron for ship!\nYou have: ${player.resources.iron} Iron`);
    }
}

function showBuildMenu() {
    showNotification(`
    üèóÔ∏è BUILD MENU:
    
    Available to build:
    
    ‚Ä¢ SCOUT SHIP - 50 Iron
    Fast exploration vessel
    
    ‚Ä¢ CARGO SHIP - 100 Iron
    Carries resources
    
    ‚Ä¢ MINING STATION - 200 Iron
    Auto-mines nearby rocks
    
    Keep mining to get more Iron!
    `, 6000);
}

function showGalaxyMap() {
    showNotification(`
    üåå GALAXY MAP:
    
    Current Location:
    TERRA NOVA - Level ${player.level}
    
    Nearby Planets:
    ‚Ä¢ Pyros V - 100 Iron (Volcanium)
    ‚Ä¢ Cryos-7 - 200 Iron (Crystals)
    
    Travel when you have enough resources!
    `, 5000);
}

function saveGame() {
    localStorage.setItem('eternal_save', JSON.stringify(player));
    showNotification("üíæ GAME SAVED!\nProgress stored.", 2000);
}

function loadGame() {
    const saved = localStorage.getItem('eternal_save');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            player = { ...player, ...data };
            updateUI();
            return true;
        } catch (e) {
            console.log("No save found");
        }
    }
    return false;
}

function resetGame() {
    if (confirm("Restart game? Progress will be lost.")) {
        localStorage.removeItem('eternal_save');
        player = {
            name: player.name,
            resources: { iron: 0, volcanium: 0, energy: 100 },
            level: 1,
            miningMode: false
        };
        updateUI();
        showNotification("Game reset! Start fresh.");
    }
}

// ======================
// THREE.JS GAME - FIXED VERSION
// ======================
function initGame() {
    console.log("Starting game initialization...");
    
    // Show loading
    document.getElementById('loadingMessage').style.display = 'block';
    
    // Check WebGL support
    if (!isWebGLSupported()) {
        document.getElementById('graphicsWarning').style.display = 'block';
        document.getElementById('loadingMessage').style.display = 'none';
        return;
    }
    
    try {
        // Create scene with visible background
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000022);
        scene.fog = new THREE.Fog(0x000033, 10, 100);
        
        // Create camera
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 15, 25);
        
        // Create renderer with fallback
        renderer = new THREE.WebGLRenderer({ 
            canvas: document.getElementById('gameCanvas'),
            antialias: true,
            alpha: false,
            powerPreference: "high-performance"
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        
        // Add lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(50, 100, 50);
        directionalLight.castShadow = true;
        scene.add(directionalLight);
        
        // Create simple terrain
        createTerrain();
        
        // Create player
        createPlayer();
        
        // Create resources
        createResources();
        
        // Create spaceship
        createSpaceship();
        
        // Create skybox
        createSky();
        
        // Setup simple camera controls
        setupCameraControls();
        
        // Initialize touch controls
        setTimeout(() => {
            initTouchControls();
        }, 500);
        
        // Hide loading, show game
        document.getElementById('loadingMessage').style.display = 'none';
        
        // Auto-save
        setInterval(saveGame, 30000);
        
        // Start game loop
        animate();
        
        showNotification(`Welcome, ${player.name}!`, 3000);
        setTimeout(() => {
            showNotification("Use joystick to move\nTap MINE to collect resources", 4000);
        }, 3500);
        
    } catch (error) {
        console.error("Game initialization failed:", error);
        document.getElementById('graphicsWarning').style.display = 'block';
        document.getElementById('loadingMessage').style.display = 'none';
    }
}

function isWebGLSupported() {
    try {
        const canvas = document.createElement('canvas');
        return !!(window.WebGLRenderingContext && 
                 (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
    } catch (e) {
        return false;
    }
}

function createTerrain() {
    // Simple flat terrain
    const geometry = new THREE.PlaneGeometry(200, 200, 10, 10);
    
    // Add slight variation
    const vertices = geometry.attributes.position;
    for (let i = 0; i < vertices.count; i++) {
        const x = vertices.getX(i);
        const z = vertices.getZ(i);
        const height = Math.sin(x * 0.05) * Math.cos(z * 0.05) * 2;
        vertices.setY(i, height);
    }
    geometry.computeVertexNormals();
    
    const material = new THREE.MeshPhongMaterial({ 
        color: 0x2ecc71,
        shininess: 30,
        side: THREE.DoubleSide
    });
    
    terrain = new THREE.Mesh(geometry, material);
    terrain.rotation.x = -Math.PI / 2;
    terrain.receiveShadow = true;
    scene.add(terrain);
    
    // Add grid for visibility
    const grid = new THREE.GridHelper(200, 20, 0x00aaff, 0x0088ff);
    grid.position.y = 0.1;
    scene.add(grid);
}

function createPlayer() {
    // Simple player capsule
    const geometry = new THREE.CapsuleGeometry(0.5, 1.5, 8, 16);
    const material = new THREE.MeshPhongMaterial({ 
        color: 0x1a5fb4,
        shininess: 100
    });
    
    playerModel = new THREE.Mesh(geometry, material);
    playerModel.position.set(0, 1.5, 0);
    playerModel.castShadow = true;
    scene.add(playerModel);
}

function createResources() {
    resourceNodes = [];
    
    // Create visible resources
    for (let i = 0; i < 15; i++) {
        const size = 1.5 + Math.random();
        const geometry = new THREE.SphereGeometry(size, 16, 16);
        const material = new THREE.MeshPhongMaterial({ 
            color: Math.random() > 0.5 ? 0xffaa00 : 0xff5555,
            emissive: Math.random() > 0.5 ? 0x884400 : 0x550000,
            emissiveIntensity: 0.8,
            shininess: 100
        });
        
        const node = new THREE.Mesh(geometry, material);
        
        const angle = Math.random() * Math.PI * 2;
        const distance = 10 + Math.random() * 30;
        node.position.set(
            Math.cos(angle) * distance,
            size,
            Math.sin(angle) * distance
        );
        
        node.castShadow = true;
        scene.add(node);
        
        resourceNodes.push({
            mesh: node,
            type: Math.random() > 0.5 ? 'iron' : 'volcanium',
            amount: 30 + Math.floor(Math.random() * 70),
            collected: false
        });
    }
}

function createSpaceship() {
    const geometry = new THREE.ConeGeometry(3, 6, 8);
    const material = new THREE.MeshPhongMaterial({ 
        color: 0x1a5fb4,
        emissive: 0x004488,
        emissiveIntensity: 1,
        shininess: 100
    });
    
    spaceship = new THREE.Mesh(geometry, material);
    spaceship.rotation.x = Math.PI / 2;
    spaceship.position.set(0, 4, -25);
    spaceship.castShadow = true;
    scene.add(spaceship);
}

function createSky() {
    // Add stars
    const starGeometry = new THREE.BufferGeometry();
    const starCount = 500;
    const starPositions = new Float32Array(starCount * 3);
    
    for (let i = 0; i < starCount * 3; i++) {
        starPositions[i] = (Math.random() - 0.5) * 500;
    }
    
    starGeometry.setAttribute('position', new THREE.BufferAttribute(starPositions, 3));
    const starMaterial = new THREE.PointsMaterial({ 
        color: 0xffffff,
        size: 2,
        sizeAttenuation: true
    });
    
    const stars = new THREE.Points(starGeometry, starMaterial);
    scene.add(stars);
}

function setupCameraControls() {
    // Simple follow camera
    if (typeof THREE.OrbitControls !== 'undefined') {
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 5;
        controls.maxDistance = 50;
        controls.maxPolarAngle = Math.PI / 2;
        controls.target.set(0, 0, 0);
    }
}

function mineResource(node, index) {
    if (!player.miningMode || node.collected) return;
    
    const amount = Math.min(10, node.amount);
    node.amount -= amount;
    
    if (node.type === 'iron') {
        player.resources.iron += amount;
    } else {
        player.resources.volcanium += amount;
    }
    
    // Visual effects
    node.mesh.scale.multiplyScalar(0.8);
    node.mesh.material.emissiveIntensity = 2;
    
    if (node.amount <= 0) {
        node.collected = true;
        scene.remove(node.mesh);
        resourceNodes.splice(index, 1);
        showNotification(`üíé Resource depleted!`, 2000);
    } else {
        showNotification(`+${amount} ${node.type.toUpperCase()}!`, 1500);
    }
    
    // Energy consumption
    player.resources.energy = Math.max(0, player.resources.energy - 1);
    
    // Level up
    player.level += amount / 100;
    if (Math.floor(player.level) > Math.floor(player.level - amount/100)) {
        showNotification(`üéâ LEVEL UP!`, 3000);
    }
    
    updateUI();
}

// ======================
// GAME LOOP
// ======================
function animate() {
    requestAnimationFrame(animate);
    
    const deltaTime = 0.016; // Fixed delta time for consistency
    
    // Update player movement
    if (playerModel && joystickActive) {
        const speed = 10 * deltaTime;
        playerModel.position.x += touchMove.x * speed;
        playerModel.position.z += touchMove.z * speed;
        
        // Keep player on ground
        playerModel.position.y = 1.5;
        
        // Update camera target
        if (controls) {
            controls.target.lerp(playerModel.position, 0.1);
        }
    }
    
    // Auto-mine when close and mining mode is on
    if (player.miningMode && playerModel) {
        resourceNodes.forEach((node, index) => {
            if (!node.collected) {
                const distance = playerModel.position.distanceTo(node.mesh.position);
                if (distance < 3) {
                    mineResource(node, index);
                }
            }
        });
    }
    
    // Animate resources
    resourceNodes.forEach(node => {
        if (!node.collected) {
            node.mesh.rotation.y += 0.02;
            node.mesh.position.y = node.mesh.geometry.parameters.radius + 
                                 Math.sin(Date.now() * 0.002) * 0.5;
        }
    });
    
    // Animate spaceship
    if (spaceship) {
        spaceship.rotation.y += 0.01;
        spaceship.position.y = 4 + Math.sin(Date.now() * 0.001) * 0.5;
    }
    
    // Recharge energy
    if (player.resources.energy < 100) {
        player.resources.energy += 0.1;
        if (Math.floor(player.resources.energy) % 25 === 0) {
            updateUI();
        }
    }
    
    // Update controls
    if (controls) controls.update();
    
    // Render
    renderer.render(scene, camera);
}

// ======================
// STARTUP
// ======================
function startGame() {
    const username = document.getElementById('username').value.trim() || 'Commander';
    player.name = username;
    
    // Check orientation
    if (window.innerHeight > window.innerWidth) {
        document.getElementById('orientationWarning').style.display = 'flex';
        return;
    }
    
    // Load saved game
    loadGame();
    
    // Switch to game
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('gameContainer').style.display = 'block';
    
    // Initialize game
    setTimeout(() => {
        initGame();
    }, 100);
}

function forceLandscape() {
    document.getElementById('orientationWarning').style.display = 'none';
    startGame();
}

// Handle resize
window.addEventListener('resize', () => {
    if (camera && renderer) {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }
});

// Handle orientation
window.addEventListener('orientationchange', () => {
    setTimeout(() => {
        if (window.innerHeight > window.innerWidth) {
            if (document.getElementById('gameContainer').style.display === 'block') {
                document.getElementById('orientationWarning').style.display = 'flex';
            }
        }
        
        if (camera && renderer) {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    }, 300);
});

// Pre-fill and focus
window.addEventListener('load', () => {
    console.log("Eternal Empire Mobile Ready!");
    document.getElementById('username').value = "MobileCommander";
    document.getElementById('username').focus();
    
    // Add click sound simulation
    document.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('touchstart', () => {
            // Visual feedback is enough
        });
    });
});
</script>

</body>
</html>
