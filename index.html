<!DOCTYPE html>
<html>
<head>
    <title>Eternal Empire - Mobile Ready</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; }
        body { 
            font-family: 'Arial', sans-serif; 
            background: #000;
            color: white;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Login Screen */
        #loginScreen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle at center, #001122 0%, #000011 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .login-box {
            background: rgba(10, 20, 40, 0.98);
            padding: 30px;
            border-radius: 20px;
            border: 3px solid #00ccff;
            box-shadow: 0 0 50px rgba(0, 204, 255, 0.5);
            text-align: center;
            width: 100%;
            max-width: 500px;
            backdrop-filter: blur(10px);
        }
        
        .game-title {
            color: #00ffff;
            font-size: clamp(32px, 8vw, 48px);
            margin-bottom: 10px;
            text-shadow: 0 0 20px #00ffff;
            letter-spacing: 2px;
        }
        
        .game-subtitle {
            color: #88aaff;
            font-size: clamp(14px, 4vw, 18px);
            margin-bottom: 25px;
        }
        
        .login-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 30, 60, 0.8);
            border: 2px solid #0088ff;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-size: clamp(14px, 4vw, 16px);
        }
        
        .login-btn {
            width: 100%;
            padding: 18px;
            margin: 15px 0;
            background: linear-gradient(45deg, #0088ff, #00ccff);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: clamp(16px, 5vw, 20px);
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-btn:active {
            transform: scale(0.95);
            background: linear-gradient(45deg, #00ccff, #00ffff);
        }
        
        .rulebook-btn {
            background: rgba(255, 170, 0, 0.3);
            border: 2px solid #ffaa00;
            color: #ffaa00;
        }
        
        /* Game Container */
        #gameContainer {
            display: none;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }
        
        /* Top Bar - Mobile Optimized */
        #topBar {
            position: absolute;
            top: env(safe-area-inset-top, 0px);
            left: 0;
            width: 100%;
            padding: 10px 15px;
            background: rgba(0, 10, 30, 0.95);
            border-bottom: 2px solid #00aaff;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            gap: 10px;
        }
        
        .resource-display {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            flex: 1;
        }
        
        .resource-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0, 30, 60, 0.7);
            padding: 6px 10px;
            border-radius: 15px;
            border: 1px solid #00aaff;
            min-width: fit-content;
        }
        
        .resource-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        
        .resource-value {
            font-size: clamp(12px, 3vw, 16px);
            font-weight: bold;
            color: #00ffff;
            min-width: 40px;
            text-align: right;
        }
        
        /* Mobile Control Overlay */
        #mobileControls {
            position: absolute;
            bottom: env(safe-area-inset-bottom, 0px);
            left: 0;
            width: 100%;
            height: 150px;
            z-index: 50;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            padding: 20px;
        }
        
        .joystick-area {
            width: 120px;
            height: 120px;
            pointer-events: auto;
            position: relative;
        }
        
        .joystick-base {
            width: 100px;
            height: 100px;
            background: rgba(0, 20, 40, 0.7);
            border: 2px solid #00aaff;
            border-radius: 50%;
            position: absolute;
            bottom: 0;
            left: 0;
        }
        
        .joystick-thumb {
            width: 50px;
            height: 50px;
            background: rgba(0, 170, 255, 0.9);
            border: 2px solid #00ffff;
            border-radius: 50%;
            position: absolute;
            bottom: 25px;
            left: 25px;
            transition: transform 0.1s;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }
        
        .mobile-btn {
            width: 60px;
            height: 60px;
            background: rgba(0, 60, 120, 0.9);
            border: 2px solid #00aaff;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
        }
        
        .mobile-btn:active {
            background: rgba(0, 100, 200, 0.9);
            transform: scale(0.9);
        }
        
        /* Mobile Action Bar */
        #mobileActionBar {
            position: absolute;
            bottom: 160px;
            left: 0;
            width: 100%;
            padding: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
            z-index: 50;
        }
        
        .action-bar-btn {
            padding: 12px 20px;
            background: rgba(0, 40, 80, 0.9);
            border: 2px solid #00cc88;
            border-radius: 25px;
            color: white;
            font-size: clamp(12px, 3vw, 14px);
            cursor: pointer;
            min-width: 80px;
            text-align: center;
            transition: all 0.1s;
        }
        
        .action-bar-btn:active {
            background: rgba(0, 100, 200, 0.9);
            transform: scale(0.95);
        }
        
        /* Canvas */
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* Mobile Notifications */
        #mobileNotification {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 25px;
            border-radius: 15px;
            border: 3px solid #00ff88;
            color: #00ff88;
            font-size: clamp(14px, 4vw, 16px);
            display: none;
            z-index: 1000;
            text-align: center;
            max-width: 90%;
            word-wrap: break-word;
        }
        
        /* Mobile Menu Button */
        #mobileMenuBtn {
            position: absolute;
            top: env(safe-area-inset-top, 10px);
            right: 15px;
            width: 50px;
            height: 50px;
            background: rgba(0, 40, 80, 0.9);
            border: 2px solid #00aaff;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 150;
            cursor: pointer;
        }
        
        /* Mobile Menu */
        #mobileMenu {
            position: absolute;
            top: env(safe-area-inset-top, 0px);
            right: -300px;
            width: 280px;
            height: 100%;
            background: rgba(0, 20, 40, 0.98);
            border-left: 3px solid #00ccff;
            z-index: 200;
            transition: right 0.3s;
            padding: 20px;
            overflow-y: auto;
        }
        
        .menu-item {
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 40, 80, 0.5);
            border: 1px solid #0088ff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .menu-item:active {
            background: rgba(0, 100, 200, 0.7);
            transform: translateX(-5px);
        }
        
        /* Touch Indicator */
        .touch-indicator {
            position: fixed;
            width: 40px;
            height: 40px;
            background: rgba(0, 255, 255, 0.3);
            border: 2px solid #00ffff;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            transform: translate(-50%, -50%);
            display: none;
        }
        
        /* Mobile Prompt */
        #mobilePrompt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 15px;
            border: 3px solid #00ffff;
            color: #00ffff;
            font-size: clamp(14px, 4vw, 16px);
            text-align: center;
            max-width: 90%;
            display: none;
            z-index: 1000;
        }
        
        /* Rulebook Mobile */
        #rulebookModal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.98);
            display: none;
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
            padding-top: env(safe-area-inset-top, 20px);
        }
        
        .rulebook-content {
            background: rgba(0, 20, 40, 0.98);
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 20px;
            border: 3px solid #00ffff;
            padding: 20px;
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        .close-btn {
            position: absolute;
            top: env(safe-area-inset-top, 20px);
            right: 20px;
            background: #ff5555;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            z-index: 2001;
        }
        
        /* Performance Warning */
        #performanceWarning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            background: rgba(255, 100, 0, 0.9);
            color: white;
            text-align: center;
            display: none;
            z-index: 3000;
        }
        
        /* Orientation Warning */
        #orientationWarning {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 4000;
            text-align: center;
            padding: 20px;
        }
        
        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .resource-item {
                padding: 4px 8px;
            }
            
            .mobile-btn {
                width: 55px;
                height: 55px;
                font-size: 20px;
            }
            
            .joystick-area {
                width: 100px;
                height: 100px;
            }
            
            .joystick-base {
                width: 80px;
                height: 80px;
            }
            
            .joystick-thumb {
                width: 40px;
                height: 40px;
                bottom: 20px;
                left: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .resource-display {
                gap: 5px;
            }
            
            .resource-item {
                font-size: 12px;
            }
            
            #mobileActionBar {
                bottom: 140px;
            }
            
            .action-bar-btn {
                padding: 10px 15px;
                min-width: 70px;
                font-size: 12px;
            }
        }
        
        /* Safe Area Insets for Notches */
        @supports(padding: max(0px)) {
            #topBar {
                padding-top: max(10px, env(safe-area-inset-top));
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }
            
            #mobileControls {
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>

<!-- Touch Indicator -->
<div class="touch-indicator" id="touchIndicator"></div>

<!-- Orientation Warning -->
<div id="orientationWarning">
    <div style="color: #00ffff; font-size: 24px; max-width: 300px;">
        üîÑ Please rotate your device to landscape mode for the best gaming experience!
    </div>
</div>

<!-- Performance Warning -->
<div id="performanceWarning">
    ‚ö†Ô∏è Low performance detected. Reducing graphics quality...
</div>

<!-- Login Screen -->
<div id="loginScreen">
    <div class="login-box">
        <div class="game-title">ETERNAL EMPIRE</div>
        <div class="game-subtitle">Mobile Edition</div>
        
        <input type="text" id="username" class="login-input" placeholder="Commander Name" maxlength="20">
        <input type="password" id="password" class="login-input" placeholder="Access Code (any)">
        
        <button class="login-btn" onclick="startGame()">üöÄ LAUNCH GAME</button>
        <button class="login-btn rulebook-btn" onclick="showRulebook()">üìñ RULEBOOK</button>
        
        <div style="margin-top: 20px; color: #88aaff; font-size: 12px;">
            Touch controls ‚Ä¢ Auto-save ‚Ä¢ Mobile optimized
        </div>
    </div>
</div>

<!-- Rulebook Modal -->
<div id="rulebookModal">
    <button class="close-btn" onclick="hideRulebook()">‚úï CLOSE</button>
    <div class="rulebook-content">
        <div style="color: #00ffff; font-size: 28px; margin-bottom: 20px; text-align: center;">
            üì± ETERNAL EMPIRE - MOBILE CONTROLS
        </div>
        
        <div style="background: rgba(0,40,80,0.3); padding: 15px; border-radius: 10px; margin: 15px 0;">
            <h3 style="color: #00ff88;">üéÆ TOUCH CONTROLS</h3>
            <p><strong>Left Side:</strong> Virtual joystick for movement</p>
            <p><strong>Right Side:</strong> Action buttons (Mine, Jump, Menu)</p>
            <p><strong>Bottom Center:</strong> Quick actions (Build, Ship, Map)</p>
            <p><strong>Tap rocks:</strong> To mine when mining mode is ON</p>
            <p><strong>Tap ship:</strong> To enter/travel</p>
        </div>
        
        <div style="background: rgba(0,40,80,0.3); padding: 15px; border-radius: 10px; margin: 15px 0;">
            <h3 style="color: #00ff88;">‚ö° QUICK TIPS</h3>
            <p>1. Enable mining mode before tapping rocks</p>
            <p>2. Collect 50 Iron to fuel your ship</p>
            <p>3. Use two fingers to pinch zoom camera</p>
            <p>4. Tap and drag to look around</p>
            <p>5. Menu button has all game options</p>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="login-btn" onclick="hideRulebook()" style="width: auto; padding: 15px 30px;">
                START PLAYING
            </button>
        </div>
    </div>
</div>

<!-- Game Container -->
<div id="gameContainer">
    <!-- Top Bar -->
    <div id="topBar">
        <div class="resource-display">
            <div class="resource-item">
                <div class="resource-icon" style="background: #ffaa00;"></div>
                <div>IRON: <span class="resource-value" id="ironCount">0</span></div>
            </div>
            <div class="resource-item">
                <div class="resource-icon" style="background: #ff5555;"></div>
                <div>VOLC: <span class="resource-value" id="volcaniumCount">0</span></div>
            </div>
            <div class="resource-item">
                <div class="resource-icon" style="background: #00ff88;"></div>
                <div>NRG: <span class="resource-value" id="energyCount">100</span></div>
            </div>
        </div>
        <div style="color: #00ffff; font-size: 14px;">
            LVL: <span id="playerLevel">1</span>
        </div>
    </div>
    
    <!-- Mobile Menu Button -->
    <div id="mobileMenuBtn" onclick="toggleMobileMenu()">‚ò∞</div>
    
    <!-- Mobile Menu -->
    <div id="mobileMenu">
        <div class="menu-item" onclick="toggleMiningMode()">
            ‚õèÔ∏è Mining Mode: <span id="menuMiningStatus">OFF</span>
        </div>
        <div class="menu-item" onclick="enterShip()">
            üöÄ Enter Ship
        </div>
        <div class="menu-item" onclick="showBuildMenu()">
            üèóÔ∏è Build Menu
        </div>
        <div class="menu-item" onclick="showGalaxyMap()">
            üåå Galaxy Map
        </div>
        <div class="menu-item" onclick="saveGame()">
            üíæ Save Game
        </div>
        <div class="menu-item" onclick="showRulebook()">
            üìñ Rulebook
        </div>
        <div class="menu-item" onclick="toggleMobileMenu()" style="background: rgba(255,50,50,0.3);">
            ‚úï Close Menu
        </div>
    </div>
    
    <!-- Mobile Action Bar -->
    <div id="mobileActionBar">
        <div class="action-bar-btn" onclick="toggleMiningMode()" id="mobileMiningBtn">
            ‚õèÔ∏è MINE
        </div>
        <div class="action-bar-btn" onclick="enterShip()">
            üöÄ SHIP
        </div>
        <div class="action-bar-btn" onclick="showBuildMenu()">
            üèóÔ∏è BUILD
        </div>
        <div class="action-bar-btn" onclick="showGalaxyMap()">
            üåå MAP
        </div>
    </div>
    
    <!-- Mobile Controls -->
    <div id="mobileControls">
        <div class="joystick-area" id="joystickArea">
            <div class="joystick-base"></div>
            <div class="joystick-thumb" id="joystickThumb"></div>
        </div>
        
        <div class="action-buttons">
            <div class="mobile-btn" id="jumpBtn" ontouchstart="mobileJump()">‚¨ÜÔ∏è</div>
            <div class="mobile-btn" id="mineBtn" ontouchstart="mobileMine()">‚õèÔ∏è</div>
            <div class="mobile-btn" id="interactBtn" ontouchstart="mobileInteract()">‚úã</div>
        </div>
    </div>
    
    <!-- Canvas -->
    <div id="gameCanvas"></div>
    
    <!-- Mobile Notification -->
    <div id="mobileNotification"></div>
    
    <!-- Mobile Prompt -->
    <div id="mobilePrompt"></div>
</div>

<script>
// ======================
// MOBILE GAME STATE
// ======================
let player = {
    name: '',
    resources: {
        iron: 0,
        volcanium: 0,
        energy: 100,
        credits: 500
    },
    level: 1,
    experience: 0,
    miningMode: false,
    currentPlanet: 'TERRA NOVA'
};

// ======================
// MOBILE CONTROLS STATE
// ======================
let joystickActive = false;
let joystickOrigin = { x: 0, y: 0 };
let joystickPosition = { x: 0, y: 0 };
let touchControls = {
    moveX: 0,
    moveZ: 0,
    touchStartTime: 0
};

// ======================
// THREE.JS VARIABLES
// ======================
let scene, camera, renderer, controls;
let playerModel, terrain, spaceship;
let resourceNodes = [];
let clock = new THREE.Clock();
let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

// ======================
// MOBILE UI FUNCTIONS
// ======================
function showMobileNotification(text, duration = 3000) {
    const notification = document.getElementById('mobileNotification');
    notification.textContent = text;
    notification.style.display = 'block';
    notification.style.animation = 'none';
    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.5s forwards';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 500);
    }, duration);
}

function showMobilePrompt(text) {
    const prompt = document.getElementById('mobilePrompt');
    prompt.textContent = text;
    prompt.style.display = 'block';
    setTimeout(() => {
        prompt.style.display = 'none';
    }, 2000);
}

function toggleMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    if (menu.style.right === '0px') {
        menu.style.right = '-300px';
    } else {
        menu.style.right = '0px';
    }
}

function updateMobileUI() {
    document.getElementById('ironCount').textContent = player.resources.iron;
    document.getElementById('volcaniumCount').textContent = player.resources.volcanium;
    document.getElementById('energyCount').textContent = Math.floor(player.resources.energy);
    document.getElementById('playerLevel').textContent = player.level;
    document.getElementById('menuMiningStatus').textContent = player.miningMode ? 'ON' : 'OFF';
    
    const miningBtn = document.getElementById('mobileMiningBtn');
    if (player.miningMode) {
        miningBtn.style.background = 'rgba(0, 255, 100, 0.3)';
        miningBtn.style.borderColor = '#00ff88';
    } else {
        miningBtn.style.background = 'rgba(0, 40, 80, 0.9)';
        miningBtn.style.borderColor = '#00cc88';
    }
}

// ======================
// TOUCH CONTROLS
// ======================
function initMobileControls() {
    const joystickArea = document.getElementById('joystickArea');
    const joystickThumb = document.getElementById('joystickThumb');
    const indicator = document.getElementById('touchIndicator');
    
    // Joystick touch start
    joystickArea.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = joystickArea.getBoundingClientRect();
        
        joystickOrigin.x = rect.left + 50;
        joystickOrigin.y = rect.top + 50;
        joystickActive = true;
        
        // Show touch indicator
        indicator.style.left = touch.clientX + 'px';
        indicator.style.top = touch.clientY + 'px';
        indicator.style.display = 'block';
        
        updateJoystick(touch.clientX, touch.clientY);
    }, { passive: false });
    
    // Joystick touch move
    document.addEventListener('touchmove', (e) => {
        if (!joystickActive) return;
        e.preventDefault();
        
        const touch = e.touches[0];
        updateJoystick(touch.clientX, touch.clientY);
        
        // Update indicator
        indicator.style.left = touch.clientX + 'px';
        indicator.style.top = touch.clientY + 'px';
    }, { passive: false });
    
    // Touch end
    document.addEventListener('touchend', (e) => {
        if (joystickActive) {
            joystickActive = false;
            joystickThumb.style.transform = 'translate(0, 0)';
            touchControls.moveX = 0;
            touchControls.moveZ = 0;
            indicator.style.display = 'none';
        }
    });
    
    // Tap to mine/interact
    renderer.domElement.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
            const touch = e.touches[0];
            handleTap(touch.clientX, touch.clientY);
        }
    });
    
    // Pinch zoom for camera
    let initialPinchDistance = 0;
    renderer.domElement.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            initialPinchDistance = getTouchDistance(e.touches[0], e.touches[1]);
        }
    });
    
    renderer.domElement.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
            e.preventDefault();
            const currentDistance = getTouchDistance(e.touches[0], e.touches[1]);
            const zoomDelta = (currentDistance - initialPinchDistance) * 0.01;
            
            if (camera && controls) {
                // Adjust camera distance
                const newDistance = controls.getDistance() - zoomDelta;
                controls.minDistance = 3;
                controls.maxDistance = 50;
                
                // Update camera position
                camera.position.sub(controls.target).normalize().multiplyScalar(newDistance).add(controls.target);
                initialPinchDistance = currentDistance;
            }
        }
    }, { passive: false });
}

function updateJoystick(x, y) {
    const joystickThumb = document.getElementById('joystickThumb');
    const maxDistance = 35;
    
    let deltaX = x - joystickOrigin.x;
    let deltaY = y - joystickOrigin.y;
    
    // Limit joystick movement
    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    if (distance > maxDistance) {
        deltaX = (deltaX / distance) * maxDistance;
        deltaY = (deltaY / distance) * maxDistance;
    }
    
    // Update thumb position
    joystickThumb.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
    
    // Normalize movement
    touchControls.moveX = deltaX / maxDistance;
    touchControls.moveZ = -deltaY / maxDistance; // Invert Y for forward/backward
}

function getTouchDistance(touch1, touch2) {
    const dx = touch1.clientX - touch2.clientX;
    const dy = touch1.clientY - touch2.clientY;
    return Math.sqrt(dx * dx + dy * dy);
}

function handleTap(screenX, screenY) {
    // Convert screen coordinates to normalized device coordinates
    const x = (screenX / window.innerWidth) * 2 - 1;
    const y = -(screenY / window.innerHeight) * 2 + 1;
    
    // Create raycaster
    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(new THREE.Vector2(x, y), camera);
    
    // Check for resource nodes
    let tappedResource = false;
    resourceNodes.forEach((node, index) => {
        if (node.collected) return;
        
        const intersects = raycaster.intersectObject(node.mesh);
        if (intersects.length > 0) {
            tappedResource = true;
            if (player.miningMode) {
                mineResource(node, index);
            } else {
                showMobilePrompt("Turn on Mining Mode first!");
            }
        }
    });
    
    // Check for ship
    if (spaceship) {
        const intersects = raycaster.intersectObject(spaceship);
        if (intersects.length > 0) {
            enterShip();
        }
    }
    
    if (!tappedResource) {
        showMobilePrompt("Tap rocks to mine, ship to enter");
    }
}

// ======================
// MOBILE ACTION FUNCTIONS
// ======================
function mobileJump() {
    if (playerModel && playerModel.position.y < 3) {
        playerModel.position.y += 5;
        showMobilePrompt("Jump!");
    }
}

function mobileMine() {
    toggleMiningMode();
}

function mobileInteract() {
    showMobilePrompt("Tap objects to interact");
}

function toggleMiningMode() {
    player.miningMode = !player.miningMode;
    updateMobileUI();
    
    if (player.miningMode) {
        showMobileNotification("‚õèÔ∏è Mining Mode ON - Tap rocks to mine!");
    } else {
        showMobileNotification("‚õèÔ∏è Mining Mode OFF");
    }
}

function enterShip() {
    if (player.resources.iron >= 50) {
        player.resources.iron -= 50;
        updateMobileUI();
        showMobileNotification("üöÄ Entering ship... Fuel: 50 Iron", 3000);
    } else {
        showMobileNotification("Need 50 Iron for ship fuel!");
    }
}

function showBuildMenu() {
    showMobileNotification(`
    üèóÔ∏è BUILD MENU:
    
    Ships:
    ‚Ä¢ Scout - 50 Iron
    ‚Ä¢ Cargo - 100 Iron
    ‚Ä¢ Battle - 200 Iron
    
    Buildings:
    ‚Ä¢ Miner - 30 Iron
    ‚Ä¢ Turret - 50 Iron
    ‚Ä¢ Generator - 40 Iron
    
    Collect more resources!
    `, 5000);
}

function showGalaxyMap() {
    showMobileNotification(`
    üåå GALAXY MAP:
    
    Current: Terra Nova
    Next: Pyros V (100 Iron)
    Need Level 3 for Cryos-7
    
    Level: ${player.level}
    Iron: ${player.resources.iron}
    `, 5000);
}

// ======================
// GAME FUNCTIONS
// ======================
function mineResource(node, index) {
    const amount = Math.min(5, node.amount);
    node.amount -= amount;
    
    if (node.type === 'iron') {
        player.resources.iron += amount;
    } else if (node.type === 'volcanium') {
        player.resources.volcanium += amount;
    }
    
    // Visual feedback
    node.mesh.scale.multiplyScalar(0.9);
    node.mesh.material.emissiveIntensity = 2;
    setTimeout(() => {
        node.mesh.material.emissiveIntensity = 0.5;
    }, 200);
    
    if (node.amount <= 0) {
        node.collected = true;
        scene.remove(node.mesh);
        resourceNodes.splice(index, 1);
    }
    
    // Gain experience
    player.experience += amount;
    if (player.experience >= player.level * 50) {
        player.level++;
        player.experience = 0;
        showMobileNotification(`üéâ LEVEL UP! Now Level ${player.level}!`);
    }
    
    // Consume energy
    player.resources.energy = Math.max(0, player.resources.energy - 1);
    
    updateMobileUI();
    showMobilePrompt(`+${amount} ${node.type.toUpperCase()}`);
}

// ======================
// THREE.JS GAME
// ======================
function initGame() {
    // Check orientation
    if (window.innerHeight > window.innerWidth) {
        document.getElementById('orientationWarning').style.display = 'flex';
        return;
    }
    
    // Create scene
    scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x000033, 10, 100);
    
    // Create camera (mobile optimized)
    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 15, 25);
    
    // Create renderer (mobile optimized)
    renderer = new THREE.WebGLRenderer({ 
        antialias: true,
        alpha: true,
        powerPreference: isMobile ? "low-power" : "default"
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limit for mobile
    renderer.shadowMap.enabled = !isMobile; // Disable shadows on mobile for performance
    document.getElementById('gameCanvas').appendChild(renderer.domElement);
    
    // Lighting
    const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
    scene.add(ambientLight);
    
    const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
    sunLight.position.set(50, 100, 50);
    if (!isMobile) sunLight.castShadow = true;
    scene.add(sunLight);
    
    // Create player
    createPlayer();
    
    // Create terrain
    createTerrain();
    
    // Create resources
    createResources();
    
    // Create ship
    createSpaceship();
    
    // Setup orbit controls
    setupControls();
    
    // Setup mobile controls
    initMobileControls();
    
    // Start game loop
    animate();
    
    // Show welcome
    showMobileNotification(`Welcome, ${player.name}! Use joystick to move, tap rocks to mine.`, 5000);
}

function createPlayer() {
    // Simplified player for mobile
    const geometry = new THREE.CapsuleGeometry(0.5, 1.5, 8, 16);
    const material = new THREE.MeshPhongMaterial({ color: 0x1a5fb4 });
    playerModel = new THREE.Mesh(geometry, material);
    playerModel.position.set(0, 1.5, 0);
    scene.add(playerModel);
}

function createTerrain() {
    const geometry = new THREE.PlaneGeometry(100, 100, 20, 20);
    
    // Simple terrain
    const vertices = geometry.attributes.position;
    for (let i = 0; i < vertices.count; i++) {
        const x = vertices.getX(i);
        const z = vertices.getZ(i);
        const height = Math.sin(x * 0.1) * Math.cos(z * 0.1) * 2;
        vertices.setY(i, height);
    }
    geometry.computeVertexNormals();
    
    const material = new THREE.MeshPhongMaterial({ 
        color: 0x2ecc71,
        shininess: 20
    });
    
    terrain = new THREE.Mesh(geometry, material);
    terrain.rotation.x = -Math.PI / 2;
    scene.add(terrain);
}

function createResources() {
    resourceNodes = [];
    
    // Create fewer resources on mobile
    const count = isMobile ? 10 : 20;
    
    for (let i = 0; i < count; i++) {
        const size = 1 + Math.random();
        const geometry = new THREE.OctahedronGeometry(size, 0);
        const material = new THREE.MeshPhongMaterial({ 
            color: Math.random() > 0.3 ? 0x888888 : 0xff3300,
            emissive: Math.random() > 0.3 ? 0x444444 : 0x550000,
            emissiveIntensity: 0.5
        });
        
        const node = new THREE.Mesh(geometry, material);
        
        const angle = Math.random() * Math.PI * 2;
        const distance = 15 + Math.random() * 40;
        node.position.set(
            Math.cos(angle) * distance,
            size + 0.5,
            Math.sin(angle) * distance
        );
        
        scene.add(node);
        
        resourceNodes.push({
            mesh: node,
            type: Math.random() > 0.3 ? 'iron' : 'volcanium',
            amount: 50 + Math.floor(Math.random() * 100),
            collected: false
        });
    }
}

function createSpaceship() {
    const geometry = new THREE.ConeGeometry(2, 4, 6);
    const material = new THREE.MeshPhongMaterial({ 
        color: 0x1a5fb4,
        emissive: 0x004488,
        emissiveIntensity: 0.5
    });
    
    spaceship = new THREE.Mesh(geometry, material);
    spaceship.rotation.x = Math.PI / 2;
    spaceship.position.set(0, 3, -20);
    scene.add(spaceship);
}

function setupControls() {
    // Simple orbit controls for mobile
    if (typeof THREE.OrbitControls !== 'undefined') {
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 5;
        controls.maxDistance = 50;
        controls.maxPolarAngle = Math.PI / 2;
        
        // Disable some controls for mobile
        if (isMobile) {
            controls.enableZoom = false;
            controls.enablePan = false;
        }
    }
}

// ======================
// GAME LOOP
// ======================
function animate() {
    requestAnimationFrame(animate);
    
    const delta = clock.getDelta();
    
    // Update player movement from joystick
    if (playerModel && joystickActive) {
        const moveSpeed = 5 * delta;
        playerModel.position.x += touchControls.moveX * moveSpeed;
        playerModel.position.z += touchControls.moveZ * moveSpeed;
        
        // Keep player on terrain
        playerModel.position.y = 1.5;
        
        // Update camera target
        if (controls) {
            controls.target.copy(playerModel.position);
        }
    }
    
    // Rotate resources
    resourceNodes.forEach(node => {
        if (!node.collected) {
            node.mesh.rotation.y += 0.01;
        }
    });
    
    // Rotate ship
    if (spaceship) {
        spaceship.rotation.y += 0.005;
    }
    
    // Recharge energy
    if (player.resources.energy < 100) {
        player.resources.energy += 0.05;
        if (Math.floor(player.resources.energy) % 10 === 0) {
            updateMobileUI();
        }
    }
    
    // Update controls
    if (controls) controls.update();
    
    renderer.render(scene, camera);
}

// ======================
// SAVE/LOAD
// ======================
function saveGame() {
    const saveData = {
        player: player,
        timestamp: Date.now()
    };
    localStorage.setItem('eternal_empire_mobile_save', JSON.stringify(saveData));
    showMobileNotification("üíæ Game saved!", 2000);
}

function loadGame() {
    const saved = localStorage.getItem('eternal_empire_mobile_save');
    if (saved) {
        try {
            const saveData = JSON.parse(saved);
            player = saveData.player;
            updateMobileUI();
            return true;
        } catch (e) {
            console.error("Failed to load save:", e);
        }
    }
    return false;
}

// ======================
// STARTUP
// ======================
function startGame() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
        alert("Please enter your name!");
        return;
    }
    
    player.name = username;
    
    // Load saved game if exists
    loadGame();
    
    // Hide login
    document.getElementById('loginScreen').style.display = 'none';
    
    // Show game
    document.getElementById('gameContainer').style.display = 'block';
    
    // Initialize game
    initGame();
    
    // Auto-save
    setInterval(saveGame, 60000); // Save every minute
    
    // Performance monitor
    if (isMobile) {
        setInterval(() => {
            if (performance.memory && performance.memory.usedJSHeapSize > 50000000) {
                document.getElementById('performanceWarning').style.display = 'block';
            }
        }, 5000);
    }
}

function showRulebook() {
    document.getElementById('rulebookModal').style.display = 'block';
}

function hideRulebook() {
    document.getElementById('rulebookModal').style.display = 'none';
}

// ======================
// MOBILE EVENTS
// ======================
window.addEventListener('load', () => {
    console.log("Eternal Empire Mobile loaded!");
    
    // Handle orientation changes
    window.addEventListener('orientationchange', () => {
        setTimeout(() => {
            if (window.innerHeight > window.innerWidth) {
                document.getElementById('orientationWarning').style.display = 'flex';
            } else {
                document.getElementById('orientationWarning').style.display = 'none';
            }
            
            // Update camera aspect ratio
            if (camera) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        }, 300);
    });
    
    // Prevent context menu on long press
    document.addEventListener('contextmenu', (e) => e.preventDefault());
    
    // Prevent pull-to-refresh
    document.addEventListener('touchmove', (e) => {
        if (e.scale !== 1) e.preventDefault();
    }, { passive: false });
    
    // Handle back button on Android
    if (isMobile) {
        window.addEventListener('popstate', (e) => {
            if (document.getElementById('gameContainer').style.display === 'block') {
                e.preventDefault();
                showMobileNotification("Use the menu to exit");
            }
        });
    }
    
    // Pre-fill username for testing
    document.getElementById('username').value = "MobileCommander";
});

// Add CSS animation
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>

</body>
</html>
