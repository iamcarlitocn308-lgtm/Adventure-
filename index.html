<!DOCTYPE html>
<html>
<head>
    <title>Eternal Empire - Working Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            color: white;
            background: #000;
        }
        
        /* Login Screen */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #001144 0%, #000022 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .login-box {
            background: rgba(0, 30, 60, 0.95);
            padding: 40px;
            border-radius: 25px;
            border: 4px solid #00aaff;
            box-shadow: 0 0 60px rgba(0, 170, 255, 0.6);
            text-align: center;
            width: 100%;
            max-width: 600px;
        }
        
        .game-title {
            color: #00ffff;
            font-size: 56px;
            margin-bottom: 15px;
            text-shadow: 0 0 30px #00ffff;
            letter-spacing: 3px;
            font-weight: bold;
        }
        
        .game-subtitle {
            color: #88ccff;
            font-size: 22px;
            margin-bottom: 40px;
        }
        
        .login-input {
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            background: rgba(0, 40, 80, 0.8);
            border: 3px solid #0088ff;
            border-radius: 15px;
            color: white;
            font-size: 22px;
            text-align: center;
        }
        
        .login-btn {
            width: 100%;
            padding: 25px;
            margin: 20px 0;
            background: linear-gradient(45deg, #0088ff, #00ccff);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-btn:active {
            transform: scale(0.95);
            background: linear-gradient(45deg, #00ccff, #00ffff);
            box-shadow: 0 0 40px #00ffff;
        }
        
        /* Game Container */
        #gameContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        /* Top Bar */
        #topBar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: rgba(0, 10, 30, 0.95);
            border-bottom: 3px solid #00aaff;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            gap: 15px;
            min-height: 90px;
        }
        
        .resource-display {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            flex: 1;
        }
        
        .resource-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 40, 80, 0.8);
            padding: 12px 20px;
            border-radius: 20px;
            border: 2px solid #00aaff;
            min-width: 140px;
        }
        
        .resource-value {
            font-size: 22px;
            font-weight: bold;
            color: #00ffff;
            min-width: 60px;
            text-align: right;
        }
        
        /* Guide Modal */
        #guideModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .guide-content {
            background: rgba(0, 30, 60, 0.98);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: 25px;
            border: 4px solid #00ffff;
            padding: 30px;
            overflow-y: auto;
            position: relative;
        }
        
        .guide-title {
            color: #00ffff;
            font-size: 36px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .guide-section {
            background: rgba(0, 50, 100, 0.5);
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            border-left: 5px solid #00aaff;
        }
        
        .guide-section h3 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .guide-section p {
            color: #ccccff;
            margin: 8px 0;
            font-size: 18px;
            line-height: 1.5;
        }
        
        .close-guide-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ff5555;
            border: none;
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
        }
        
        /* Mobile Controls */
        #mobileControls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 180px;
            z-index: 50;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom, 20px));
        }
        
        .joystick-area {
            width: 150px;
            height: 150px;
            pointer-events: auto;
            position: relative;
        }
        
        .joystick-base {
            width: 140px;
            height: 140px;
            background: rgba(0, 30, 60, 0.9);
            border: 4px solid #00aaff;
            border-radius: 50%;
            position: absolute;
            bottom: 0;
            left: 0;
        }
        
        .joystick-thumb {
            width: 70px;
            height: 70px;
            background: rgba(0, 170, 255, 0.95);
            border: 4px solid #00ffff;
            border-radius: 50%;
            position: absolute;
            bottom: 35px;
            left: 35px;
            transition: transform 0.1s;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: auto;
        }
        
        .mobile-btn {
            width: 90px;
            height: 90px;
            background: rgba(0, 80, 160, 0.95);
            border: 4px solid #00aaff;
            border-radius: 50%;
            color: white;
            font-size: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .mobile-btn:active {
            background: rgba(0, 150, 255, 0.95);
            transform: scale(0.9);
            box-shadow: 0 0 30px #00ffff;
        }
        
        /* Action Bar */
        #mobileActionBar {
            position: absolute;
            bottom: 200px;
            left: 0;
            width: 100%;
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 50;
            flex-wrap: wrap;
        }
        
        .action-bar-btn {
            padding: 20px 30px;
            background: rgba(0, 60, 120, 0.95);
            border: 3px solid #00cc88;
            border-radius: 30px;
            color: white;
            font-size: 22px;
            cursor: pointer;
            min-width: 120px;
            text-align: center;
            transition: all 0.1s;
        }
        
        .action-bar-btn:active {
            background: rgba(0, 150, 200, 0.95);
            transform: scale(0.95);
            box-shadow: 0 0 30px #00ff88;
        }
        
        /* Canvas */
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000033;
        }
        
        /* Notification */
        #notification {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 25px 35px;
            border-radius: 20px;
            border: 4px solid #00ff88;
            color: #00ff88;
            font-size: 20px;
            display: none;
            z-index: 1000;
            text-align: center;
            max-width: 90%;
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        /* Menu Button */
        #mobileMenuBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: rgba(0, 60, 120, 0.95);
            border: 3px solid #00aaff;
            border-radius: 50%;
            color: white;
            font-size: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 150;
            cursor: pointer;
        }
        
        /* Menu */
        #mobileMenu {
            position: absolute;
            top: 0;
            right: -350px;
            width: 320px;
            height: 100%;
            background: rgba(0, 30, 60, 0.98);
            border-left: 4px solid #00ccff;
            z-index: 200;
            transition: right 0.3s;
            padding: 25px;
            overflow-y: auto;
            padding-top: 100px;
        }
        
        .menu-item {
            padding: 25px;
            margin: 15px 0;
            background: rgba(0, 60, 120, 0.7);
            border: 2px solid #0088ff;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 20px;
            text-align: center;
        }
        
        .menu-item:active {
            background: rgba(0, 120, 240, 0.8);
            transform: translateX(-10px);
        }
        
        /* Simple Graphics Warning */
        #simpleGraphics {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 20, 40, 0.98);
            padding: 30px;
            border-radius: 20px;
            border: 4px solid #ffaa00;
            color: #ffaa00;
            font-size: 24px;
            text-align: center;
            max-width: 90%;
            z-index: 3000;
            display: none;
        }
        
        .simple-btn {
            padding: 20px 40px;
            margin: 20px 10px;
            background: #00aaff;
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 22px;
            cursor: pointer;
        }
        
        /* Animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>

<!-- Simple Graphics Fallback -->
<div id="simpleGraphics">
    <div style="font-size: 32px; margin-bottom: 20px;">‚ö†Ô∏è Graphics Mode</div>
    <div style="margin-bottom: 30px; color: #88aaff; font-size: 20px;">
        Choose graphics quality for your device:
    </div>
    <button class="simple-btn" onclick="startSimpleGraphics()">Simple Mode (Best Performance)</button>
    <button class="simple-btn" onclick="startAdvancedGraphics()">Advanced Mode (Better Graphics)</button>
    <div style="margin-top: 30px; color: #ffaa00; font-size: 18px;">
        Simple mode works on all devices
    </div>
</div>

<!-- Guide Modal -->
<div id="guideModal">
    <div class="guide-content">
        <button class="close-guide-btn" onclick="hideGuide()">‚úï CLOSE</button>
        
        <div class="guide-title">üéÆ ETERNAL EMPIRE GUIDE</div>
        
        <div class="guide-section">
            <h3>üöÄ HOW TO PLAY</h3>
            <p><strong>1. Move:</strong> Use the left joystick to move your character</p>
            <p><strong>2. Mine:</strong> Tap the ‚õèÔ∏è button to enable mining mode</p>
            <p><strong>3. Collect:</strong> Walk near glowing rocks to collect resources</p>
            <p><strong>4. Build:</strong> Collect 50 Iron, then tap the üöÄ button to enter ship</p>
            <p><strong>5. Progress:</strong> Keep mining to unlock new features!</p>
        </div>
        
        <div class="guide-section">
            <h3>‚õèÔ∏è MINING SYSTEM</h3>
            <p>‚Ä¢ <strong>Iron Rocks</strong> (Orange/Yellow) - Basic resource</p>
            <p>‚Ä¢ <strong>Volcanium Rocks</strong> (Red) - Advanced resource</p>
            <p>‚Ä¢ Mining uses Energy (green bar)</p>
            <p>‚Ä¢ Energy recharges over time</p>
            <p>‚Ä¢ Walk CLOSE to rocks to auto-mine</p>
        </div>
        
        <div class="guide-section">
            <h3>üèóÔ∏è BUILDING SYSTEM</h3>
            <p>‚Ä¢ <strong>Scout Ship</strong> - 50 Iron (Fast travel)</p>
            <p>‚Ä¢ <strong>Cargo Ship</strong> - 100 Iron (More storage)</p>
            <p>‚Ä¢ <strong>Battleship</strong> - 200 Iron, 50 Volcanium</p>
            <p>‚Ä¢ <strong>Mining Station</strong> - 150 Iron (Auto-mines)</p>
            <p>‚Ä¢ <strong>Defense Turret</strong> - 80 Iron (Protection)</p>
        </div>
        
        <div class="guide-section">
            <h3>üåå GALAXY PROGRESSION</h3>
            <p>Start on <strong>Terra Nova</strong> (Green planet)</p>
            <p>Unlock <strong>Pyros V</strong> at 500 Iron (Lava planet)</p>
            <p>Unlock <strong>Cryos-7</strong> at Level 5 (Ice planet)</p>
            <p>Each planet has unique resources!</p>
        </div>
        
        <div class="guide-section">
            <h3>üì± TOUCH CONTROLS</h3>
            <p><strong>Left Side:</strong> Joystick for movement</p>
            <p><strong>Right Side:</strong> Action buttons</p>
            <p><strong>Top Right:</strong> ‚ò∞ Menu button</p>
            <p><strong>Bottom Center:</strong> Quick action buttons</p>
            <p><strong>Tap Rocks:</strong> Quick mine when close</p>
        </div>
        
        <div class="guide-section">
            <h3>üí° QUICK TIPS</h3>
            <p>1. Start by mining Iron near your starting point</p>
            <p>2. Enable mining mode BEFORE approaching rocks</p>
            <p>3. Watch your Energy level - rest if it gets low</p>
            <p>4. Save often using the menu</p>
            <p>5. Complete the tutorial goals for bonuses</p>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="login-btn" onclick="hideGuide()" style="width: auto; padding: 20px 50px;">
                START PLAYING NOW
            </button>
        </div>
    </div>
</div>

<!-- Login Screen -->
<div id="loginScreen">
    <div class="login-box">
        <div class="game-title">ETERNAL EMPIRE</div>
        <div class="game-subtitle">A Complete Space Adventure</div>
        
        <input type="text" id="username" class="login-input" placeholder="ENTER COMMANDER NAME" maxlength="15">
        
        <button class="login-btn" onclick="showGraphicsOptions()">
            üöÄ START GAME
        </button>
        <button class="login-btn" onclick="showGuide()" style="background: linear-gradient(45deg, #ff8800, #ffaa00);">
            üìñ FULL GUIDE
        </button>
        
        <div style="margin-top: 30px; color: #88aaff; font-size: 18px;">
            Works on all devices ‚Ä¢ Auto-save ‚Ä¢ Free to play
        </div>
    </div>
</div>

<!-- Game Container -->
<div id="gameContainer">
    <!-- Top Bar -->
    <div id="topBar">
        <div class="resource-display">
            <div class="resource-item">
                <div style="color: #ffaa00; font-weight: bold;">IRON:</div>
                <div class="resource-value" id="ironCount">0</div>
            </div>
            <div class="resource-item">
                <div style="color: #ff5555; font-weight: bold;">VOLCANIUM:</div>
                <div class="resource-value" id="volcaniumCount">0</div>
            </div>
            <div class="resource-item">
                <div style="color: #00ff88; font-weight: bold;">ENERGY:</div>
                <div class="resource-value" id="energyCount">100</div>
            </div>
        </div>
        <div style="color: #00ffff; font-size: 24px; font-weight: bold;">
            LEVEL: <span id="playerLevel">1</span>
        </div>
    </div>
    
    <!-- Menu Button -->
    <div id="mobileMenuBtn" onclick="toggleMobileMenu()">‚ò∞</div>
    
    <!-- Mobile Menu -->
    <div id="mobileMenu">
        <div class="menu-item" onclick="toggleMiningMode()">
            ‚õèÔ∏è MINING: <span id="menuMiningStatus">OFF</span>
        </div>
        <div class="menu-item" onclick="enterShip()">
            üöÄ ENTER SPACESHIP
        </div>
        <div class="menu-item" onclick="showBuildMenu()">
            üèóÔ∏è BUILD MENU
        </div>
        <div class="menu-item" onclick="showGalaxyMap()">
            üåå GALAXY MAP
        </div>
        <div class="menu-item" onclick="saveGame()">
            üíæ SAVE GAME
        </div>
        <div class="menu-item" onclick="showGuide()">
            üìñ GAME GUIDE
        </div>
        <div class="menu-item" onclick="toggleGraphics()">
            ‚öôÔ∏è GRAPHICS: <span id="graphicsMode">SIMPLE</span>
        </div>
        <div class="menu-item" onclick="toggleMobileMenu()" style="background: rgba(0,0,0,0.5);">
            ‚úï CLOSE MENU
        </div>
    </div>
    
    <!-- Action Bar -->
    <div id="mobileActionBar">
        <div class="action-bar-btn" onclick="toggleMiningMode()" id="mobileMiningBtn">
            ‚õèÔ∏è MINE
        </div>
        <div class="action-bar-btn" onclick="enterShip()">
            üöÄ SHIP
        </div>
        <div class="action-bar-btn" onclick="showBuildMenu()">
            üèóÔ∏è BUILD
        </div>
        <div class="action-bar-btn" onclick="showGuide()">
            üìñ GUIDE
        </div>
    </div>
    
    <!-- Mobile Controls -->
    <div id="mobileControls">
        <div class="joystick-area" id="joystickArea">
            <div class="joystick-base"></div>
            <div class="joystick-thumb" id="joystickThumb"></div>
        </div>
        
        <div class="action-buttons">
            <div class="mobile-btn" id="jumpBtn" ontouchstart="mobileJump()">
                ‚¨ÜÔ∏è
            </div>
            <div class="mobile-btn" id="mineBtn" ontouchstart="mobileMine()">
                ‚õèÔ∏è
            </div>
            <div class="mobile-btn" id="actionBtn" ontouchstart="mobileAction()">
                ‚≠ê
            </div>
        </div>
    </div>
    
    <!-- Canvas -->
    <canvas id="gameCanvas"></canvas>
    
    <!-- Notification -->
    <div id="notification"></div>
</div>

<script>
// ======================
// GAME STATE
// ======================
let player = {
    name: 'Commander',
    resources: {
        iron: 0,
        volcanium: 0,
        energy: 100
    },
    level: 1,
    experience: 0,
    miningMode: false,
    graphicsMode: 'simple' // simple or advanced
};

// ======================
// THREE.JS VARIABLES
// ======================
let scene, camera, renderer;
let playerModel, terrain, spaceship;
let resourceNodes = [];
let joystickActive = false;
let touchMove = { x: 0, z: 0 };

// ======================
// UI FUNCTIONS
// ======================
function showNotification(text, duration = 3000) {
    const notification = document.getElementById('notification');
    notification.textContent = text;
    notification.style.display = 'block';
    notification.classList.add('fade-in');
    
    setTimeout(() => {
        notification.style.display = 'none';
        notification.classList.remove('fade-in');
    }, duration);
}

function updateUI() {
    document.getElementById('ironCount').textContent = player.resources.iron;
    document.getElementById('volcaniumCount').textContent = player.resources.volcanium;
    document.getElementById('energyCount').textContent = Math.floor(player.resources.energy);
    document.getElementById('playerLevel').textContent = player.level;
    document.getElementById('menuMiningStatus').textContent = player.miningMode ? 'ON' : 'OFF';
    document.getElementById('graphicsMode').textContent = player.graphicsMode.toUpperCase();
    
    const miningBtn = document.getElementById('mobileMiningBtn');
    if (player.miningMode) {
        miningBtn.style.background = 'rgba(0, 255, 100, 0.95)';
        miningBtn.innerHTML = '‚úÖ MINE';
    } else {
        miningBtn.style.background = 'rgba(0, 60, 120, 0.95)';
        miningBtn.innerHTML = '‚õèÔ∏è MINE';
    }
}

function showGuide() {
    document.getElementById('guideModal').style.display = 'flex';
}

function hideGuide() {
    document.getElementById('guideModal').style.display = 'none';
}

function toggleMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    if (menu.style.right === '0px') {
        menu.style.right = '-350px';
    } else {
        menu.style.right = '0px';
    }
}

// ======================
// GRAPHICS FUNCTIONS
// ======================
function showGraphicsOptions() {
    const username = document.getElementById('username').value.trim() || 'Commander';
    player.name = username;
    document.getElementById('simpleGraphics').style.display = 'block';
}

function startSimpleGraphics() {
    player.graphicsMode = 'simple';
    document.getElementById('simpleGraphics').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('gameContainer').style.display = 'block';
    initSimpleGame();
}

function startAdvancedGraphics() {
    player.graphicsMode = 'advanced';
    document.getElementById('simpleGraphics').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('gameContainer').style.display = 'block';
    initAdvancedGame();
}

function toggleGraphics() {
    if (player.graphicsMode === 'simple') {
        player.graphicsMode = 'advanced';
        showNotification("Switching to Advanced Graphics...");
        setTimeout(() => {
            initAdvancedGame();
        }, 1000);
    } else {
        player.graphicsMode = 'simple';
        showNotification("Switching to Simple Graphics...");
        setTimeout(() => {
            initSimpleGame();
        }, 1000);
    }
    updateUI();
}

// ======================
// SIMPLE GRAPHICS MODE (ALWAYS WORKS)
// ======================
function initSimpleGame() {
    console.log("Starting Simple Graphics Mode...");
    
    try {
        // Create canvas if it doesn't exist
        let canvas = document.getElementById('gameCanvas');
        if (!canvas) {
            canvas = document.createElement('canvas');
            canvas.id = 'gameCanvas';
            document.getElementById('gameContainer').appendChild(canvas);
        }
        
        // Get WebGL context with fallback to 2D
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) {
            // Fallback to 2D canvas
            init2DGame();
            return;
        }
        
        // Set canvas size
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        // Create minimal Three.js scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x001133);
        
        // Simple camera
        camera = new THREE.PerspectiveCamera(75, canvas.width / canvas.height, 0.1, 1000);
        camera.position.set(0, 15, 25);
        
        // Simple renderer
        renderer = new THREE.WebGLRenderer({ 
            canvas: canvas,
            antialias: false,
            powerPreference: "low-power"
        });
        renderer.setSize(canvas.width, canvas.height);
        renderer.setPixelRatio(1); // Lowest for compatibility
        
        // Basic lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(1, 1, 1);
        scene.add(directionalLight);
        
        // Create simple game objects
        createSimpleTerrain();
        createSimplePlayer();
        createSimpleResources();
        createSimpleSpaceship();
        
        // Load saved game
        loadGame();
        
        // Setup controls
        initTouchControls();
        
        // Start game loop
        animateSimpleGame();
        
        showNotification(`Welcome ${player.name}! Simple graphics mode active.`, 4000);
        
    } catch (error) {
        console.error("Simple graphics failed:", error);
        // Ultimate fallback to 2D
        init2DGame();
    }
}

function createSimpleTerrain() {
    // Simple flat ground
    const geometry = new THREE.PlaneGeometry(100, 100);
    const material = new THREE.MeshBasicMaterial({ 
        color: 0x2ecc71,
        side: THREE.DoubleSide
    });
    
    terrain = new THREE.Mesh(geometry, material);
    terrain.rotation.x = -Math.PI / 2;
    scene.add(terrain);
    
    // Add a grid for visibility
    const grid = new THREE.GridHelper(100, 10, 0x0000ff, 0x000088);
    grid.position.y = 0.1;
    scene.add(grid);
}

function createSimplePlayer() {
    // Simple cube player
    const geometry = new THREE.BoxGeometry(1, 2, 1);
    const material = new THREE.MeshBasicMaterial({ 
        color: 0x1a5fb4
    });
    
    playerModel = new THREE.Mesh(geometry, material);
    playerModel.position.set(0, 1, 0);
    scene.add(playerModel);
}

function createSimpleResources() {
    resourceNodes = [];
    
    // Create simple resources
    for (let i = 0; i < 10; i++) {
        const size = 1 + Math.random();
        const geometry = new THREE.SphereGeometry(size, 8, 8);
        const material = new THREE.MeshBasicMaterial({ 
            color: Math.random() > 0.5 ? 0xffaa00 : 0xff5555
        });
        
        const node = new THREE.Mesh(geometry, material);
        
        const angle = Math.random() * Math.PI * 2;
        const distance = 10 + Math.random() * 30;
        node.position.set(
            Math.cos(angle) * distance,
            size,
            Math.sin(angle) * distance
        );
        
        scene.add(node);
        
        resourceNodes.push({
            mesh: node,
            type: Math.random() > 0.5 ? 'iron' : 'volcanium',
            amount: 20 + Math.floor(Math.random() * 50),
            collected: false
        });
    }
}

function createSimpleSpaceship() {
    const geometry = new THREE.ConeGeometry(2, 4, 6);
    const material = new THREE.MeshBasicMaterial({ 
        color: 0x1a5fb4
    });
    
    spaceship = new THREE.Mesh(geometry, material);
    spaceship.rotation.x = Math.PI / 2;
    spaceship.position.set(0, 2, -20);
    scene.add(spaceship);
}

function animateSimpleGame() {
    if (!scene || !camera || !renderer) return;
    
    requestAnimationFrame(animateSimpleGame);
    
    // Update player movement
    if (playerModel && joystickActive) {
        const speed = 0.1;
        playerModel.position.x += touchMove.x * speed;
        playerModel.position.z += touchMove.z * speed;
        
        // Auto-mine when close
        if (player.miningMode) {
            resourceNodes.forEach((node, index) => {
                if (!node.collected) {
                    const distance = playerModel.position.distanceTo(node.mesh.position);
                    if (distance < 3) {
                        mineResource(node, index);
                    }
                }
            });
        }
    }
    
    // Animate resources
    resourceNodes.forEach(node => {
        if (!node.collected) {
            node.mesh.rotation.y += 0.01;
        }
    });
    
    // Animate spaceship
    if (spaceship) {
        spaceship.rotation.y += 0.005;
    }
    
    // Camera follows player
    if (playerModel) {
        camera.position.x = playerModel.position.x;
        camera.position.z = playerModel.position.z + 20;
        camera.lookAt(playerModel.position.x, 0, playerModel.position.z);
    }
    
    // Recharge energy
    if (player.resources.energy < 100) {
        player.resources.energy += 0.05;
    }
    
    renderer.render(scene, camera);
}

// ======================
// ADVANCED GRAPHICS MODE
// ======================
function initAdvancedGame() {
    console.log("Starting Advanced Graphics Mode...");
    
    try {
        // Clear existing canvas
        const container = document.getElementById('gameContainer');
        const oldCanvas = document.getElementById('gameCanvas');
        if (oldCanvas) {
            container.removeChild(oldCanvas);
        }
        
        // Create new canvas
        const canvas = document.createElement('canvas');
        canvas.id = 'gameCanvas';
        container.appendChild(canvas);
        
        // Create scene with better graphics
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000033);
        scene.fog = new THREE.Fog(0x000033, 10, 100);
        
        // Better camera
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 15, 25);
        
        // Better renderer
        renderer = new THREE.WebGLRenderer({ 
            canvas: canvas,
            antialias: true,
            alpha: true,
            powerPreference: "high-performance"
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        
        // Better lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(50, 100, 50);
        directionalLight.castShadow = true;
        scene.add(directionalLight);
        
        // Create better game objects
        createAdvancedTerrain();
        createAdvancedPlayer();
        createAdvancedResources();
        createAdvancedSpaceship();
        createSkybox();
        
        // Setup orbit controls if available
        if (typeof THREE.OrbitControls !== 'undefined') {
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
        }
        
        // Start animation
        animateAdvancedGame();
        
        showNotification("Advanced graphics mode activated!", 3000);
        
    } catch (error) {
        console.error("Advanced graphics failed:", error);
        showNotification("Failed to load advanced graphics. Switching to simple mode.", 3000);
        setTimeout(() => {
            initSimpleGame();
        }, 1000);
    }
}

function createAdvancedTerrain() {
    const geometry = new THREE.PlaneGeometry(200, 200, 50, 50);
    
    // Add terrain variation
    const vertices = geometry.attributes.position;
    for (let i = 0; i < vertices.count; i++) {
        const x = vertices.getX(i);
        const z = vertices.getZ(i);
        const height = Math.sin(x * 0.05) * Math.cos(z * 0.05) * 3;
        vertices.setY(i, height);
    }
    geometry.computeVertexNormals();
    
    const material = new THREE.MeshPhongMaterial({ 
        color: 0x2ecc71,
        shininess: 30,
        side: THREE.DoubleSide
    });
    
    terrain = new THREE.Mesh(geometry, material);
    terrain.rotation.x = -Math.PI / 2;
    terrain.receiveShadow = true;
    scene.add(terrain);
}

function createAdvancedPlayer() {
    const geometry = new THREE.CapsuleGeometry(0.5, 1.5, 8, 16);
    const material = new THREE.MeshPhongMaterial({ 
        color: 0x1a5fb4,
        shininess: 100
    });
    
    playerModel = new THREE.Mesh(geometry, material);
    playerModel.position.set(0, 1.5, 0);
    playerModel.castShadow = true;
    scene.add(playerModel);
}

function createAdvancedResources() {
    resourceNodes = [];
    
    for (let i = 0; i < 15; i++) {
        const size = 1.5 + Math.random();
        const geometry = new THREE.SphereGeometry(size, 16, 16);
        const material = new THREE.MeshPhongMaterial({ 
            color: Math.random() > 0.5 ? 0xffaa00 : 0xff5555,
            emissive: Math.random() > 0.5 ? 0x884400 : 0x550000,
            emissiveIntensity: 0.5
        });
        
        const node = new THREE.Mesh(geometry, material);
        
        const angle = Math.random() * Math.PI * 2;
        const distance = 15 + Math.random() * 35;
        node.position.set(
            Math.cos(angle) * distance,
            size,
            Math.sin(angle) * distance
        );
        
        node.castShadow = true;
        scene.add(node);
        
        resourceNodes.push({
            mesh: node,
            type: Math.random() > 0.5 ? 'iron' : 'volcanium',
            amount: 30 + Math.floor(Math.random() * 70),
            collected: false
        });
    }
}

function createAdvancedSpaceship() {
    const geometry = new THREE.ConeGeometry(3, 6, 8);
    const material = new THREE.MeshPhongMaterial({ 
        color: 0x1a5fb4,
        emissive: 0x004488,
        emissiveIntensity: 0.5
    });
    
    spaceship = new THREE.Mesh(geometry, material);
    spaceship.rotation.x = Math.PI / 2;
    spaceship.position.set(0, 4, -25);
    spaceship.castShadow = true;
    scene.add(spaceship);
}

function createSkybox() {
    // Add stars
    const starGeometry = new THREE.BufferGeometry();
    const starCount = 1000;
    const starPositions = new Float32Array(starCount * 3);
    
    for (let i = 0; i < starCount * 3; i++) {
        starPositions[i] = (Math.random() - 0.5) * 1000;
    }
    
    starGeometry.setAttribute('position', new THREE.BufferAttribute(starPositions, 3));
    const starMaterial = new THREE.PointsMaterial({ 
        color: 0xffffff,
        size: 1,
        sizeAttenuation: true
    });
    
    const stars = new THREE.Points(starGeometry, starMaterial);
    scene.add(stars);
}

function animateAdvancedGame() {
    if (!scene || !camera || !renderer) return;
    
    requestAnimationFrame(animateAdvancedGame);
    
    // Update player movement
    if (playerModel && joystickActive) {
        const speed = 0.1;
        playerModel.position.x += touchMove.x * speed;
        playerModel.position.z += touchMove.z * speed;
        
        // Auto-mine when close
        if (player.miningMode) {
            resourceNodes.forEach((node, index) => {
                if (!node.collected) {
                    const distance = playerModel.position.distanceTo(node.mesh.position);
                    if (distance < 3) {
                        mineResource(node, index);
                    }
                }
            });
        }
    }
    
    // Animate resources
    resourceNodes.forEach(node => {
        if (!node.collected) {
            node.mesh.rotation.y += 0.02;
            node.mesh.position.y = node.mesh.geometry.parameters.radius + 
                                 Math.sin(Date.now() * 0.002) * 0.5;
        }
    });
    
    // Animate spaceship
    if (spaceship) {
        spaceship.rotation.y += 0.01;
        spaceship.position.y = 4 + Math.sin(Date.now() * 0.001) * 0.5;
    }
    
    // Recharge energy
    if (player.resources.energy < 100) {
        player.resources.energy += 0.05;
    }
    
    renderer.render(scene, camera);
}

// ======================
// 2D FALLBACK MODE
// ======================
function init2DGame() {
    console.log("Starting 2D Fallback Mode...");
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    // Simple 2D game objects
    const gameObjects = {
        player: { x: canvas.width/2, y: canvas.height/2, size: 20 },
        resources: [],
        ship: { x: canvas.width/2, y: 100, size: 30 }
    };
    
    // Create resources
    for (let i = 0; i < 8; i++) {
        gameObjects.resources.push({
            x: 100 + Math.random() * (canvas.width - 200),
            y: 200 + Math.random() * (canvas.height - 400),
            size: 15 + Math.random() * 10,
            type: Math.random() > 0.5 ? 'iron' : 'volcanium',
            collected: false
        });
    }
    
    function drawGame() {
        // Clear canvas
        ctx.fillStyle = '#001133';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw grid
        ctx.strokeStyle = '#003366';
        ctx.lineWidth = 1;
        for (let x = 0; x < canvas.width; x += 50) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvas.height);
            ctx.stroke();
        }
        for (let y = 0; y < canvas.height; y += 50) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
        }
        
        // Draw resources
        gameObjects.resources.forEach(resource => {
            if (!resource.collected) {
                ctx.fillStyle = resource.type === 'iron' ? '#ffaa00' : '#ff5555';
                ctx.beginPath();
                ctx.arc(resource.x, resource.y, resource.size, 0, Math.PI * 2);
                ctx.fill();
                
                // Glow effect
                ctx.shadowColor = resource.type === 'iron' ? '#ffaa00' : '#ff5555';
                ctx.shadowBlur = 15;
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        });
        
        // Draw ship
        ctx.fillStyle = '#1a5fb4';
        ctx.beginPath();
        ctx.moveTo(gameObjects.ship.x, gameObjects.ship.y);
        ctx.lineTo(gameObjects.ship.x - gameObjects.ship.size, gameObjects.ship.y + gameObjects.ship.size * 2);
        ctx.lineTo(gameObjects.ship.x + gameObjects.ship.size, gameObjects.ship.y + gameObjects.ship.size * 2);
        ctx.closePath();
        ctx.fill();
        
        // Draw player
        ctx.fillStyle = '#00aaff';
        ctx.beginPath();
        ctx.arc(gameObjects.player.x, gameObjects.player.y, gameObjects.player.size, 0, Math.PI * 2);
        ctx.fill();
        
        // Draw mining indicator
        if (player.miningMode) {
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.arc(gameObjects.player.x, gameObjects.player.y, gameObjects.player.size + 10, 0, Math.PI * 2);
            ctx.stroke();
            ctx.setLineDash([]);
        }
    }
    
    function updateGame() {
        // Move player with joystick
        if (joystickActive) {
            gameObjects.player.x += touchMove.x * 5;
            gameObjects.player.y -= touchMove.z * 5;
            
            // Keep in bounds
            gameObjects.player.x = Math.max(gameObjects.player.size, 
                Math.min(canvas.width - gameObjects.player.size, gameObjects.player.x));
            gameObjects.player.y = Math.max(gameObjects.player.size, 
                Math.min(canvas.height - gameObjects.player.size, gameObjects.player.y));
            
            // Check mining
            if (player.miningMode) {
                gameObjects.resources.forEach((resource, index) => {
                    if (!resource.collected) {
                        const dx = resource.x - gameObjects.player.x;
                        const dy = resource.y - gameObjects.player.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < gameObjects.player.size + resource.size) {
                            resource.collected = true;
                            if (resource.type === 'iron') {
                                player.resources.iron += 10;
                            } else {
                                player.resources.volcanium += 5;
                            }
                            updateUI();
                            showNotification(`Mined ${resource.type === 'iron' ? 'Iron' : 'Volcanium'}!`, 2000);
                        }
                    }
                });
            }
        }
        
        // Recharge energy
        if (player.resources.energy < 100) {
            player.resources.energy += 0.1;
            if (Math.floor(player.resources.energy) % 25 === 0) {
                updateUI();
            }
        }
        
        drawGame();
        requestAnimationFrame(updateGame);
    }
    
    // Start the 2D game
    updateGame();
    showNotification("2D Mode Active - Basic gameplay", 3000);
}

// ======================
// TOUCH CONTROLS
// ======================
function initTouchControls() {
    const joystickArea = document.getElementById('joystickArea');
    const joystickThumb = document.getElementById('joystickThumb');
    
    if (!joystickArea || !joystickThumb) return;
    
    joystickArea.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = joystickArea.getBoundingClientRect();
        
        joystickActive = true;
        updateJoystick(touch.clientX, touch.clientY, rect);
    });
    
    document.addEventListener('touchmove', (e) => {
        if (!joystickActive) return;
        e.preventDefault();
        
        const touch = e.touches[0];
        const rect = joystickArea.getBoundingClientRect();
        updateJoystick(touch.clientX, touch.clientY, rect);
    });
    
    document.addEventListener('touchend', () => {
        joystickActive = false;
        joystickThumb.style.transform = 'translate(0, 0)';
        touchMove.x = 0;
        touchMove.z = 0;
    });
}

function updateJoystick(x, y, rect) {
    const joystickThumb = document.getElementById('joystickThumb');
    const centerX = rect.left + 75;
    const centerY = rect.top + 75;
    const maxDistance = 50;
    
    let deltaX = x - centerX;
    let deltaY = y - centerY;
    
    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    if (distance > maxDistance) {
        deltaX = (deltaX / distance) * maxDistance;
        deltaY = (deltaY / distance) * maxDistance;
    }
    
    joystickThumb.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
    
    touchMove.x = deltaX / maxDistance;
    touchMove.z = -deltaY / maxDistance; // Invert for forward/backward
}

// ======================
// GAME FUNCTIONS
// ======================
function mineResource(node, index) {
    if (!player.miningMode || node.collected) return;
    
    const amount = Math.min(5, node.amount);
    node.amount -= amount;
    
    if (node.type === 'iron') {
        player.resources.iron += amount;
    } else {
        player.resources.volcanium += amount;
    }
    
    player.resources.energy = Math.max(0, player.resources.energy - 1);
    
    if (node.amount <= 0) {
        node.collected = true;
        if (scene && node.mesh) {
            scene.remove(node.mesh);
        }
        resourceNodes.splice(index, 1);
    } else {
        // Visual feedback
        if (node.mesh) {
            node.mesh.scale.multiplyScalar(0.9);
        }
    }
    
    // Gain experience
    player.experience += amount;
    if (player.experience >= player.level * 50) {
        player.level++;
        player.experience = 0;
        showNotification(`üéâ LEVEL UP! Now Level ${player.level}`, 3000);
    }
    
    updateUI();
    showNotification(`+${amount} ${node.type.toUpperCase()}!`, 1500);
}

function toggleMiningMode() {
    player.miningMode = !player.miningMode;
    updateUI();
    
    if (player.miningMode) {
        showNotification("‚õèÔ∏è MINING MODE ON\nWalk near rocks to collect!", 3000);
    } else {
        showNotification("‚õèÔ∏è Mining mode off", 2000);
    }
}

function mobileJump() {
    if (playerModel) {
        playerModel.position.y = 5;
        setTimeout(() => {
            if (playerModel) playerModel.position.y = 1.5;
        }, 500);
        showNotification("Jump!", 1000);
    }
}

function mobileMine() {
    toggleMiningMode();
}

function mobileAction() {
    // Try to mine nearest resource
    if (player.miningMode && playerModel) {
        let nearestNode = null;
        let nearestDistance = Infinity;
        
        resourceNodes.forEach((node, index) => {
            if (!node.collected) {
                const distance = playerModel.position.distanceTo(node.mesh.position);
                if (distance < 10 && distance < nearestDistance) {
                    nearestDistance = distance;
                    nearestNode = { node, index };
                }
            }
        });
        
        if (nearestNode) {
            mineResource(nearestNode.node, nearestNode.index);
        } else {
            showNotification("No resources nearby!", 2000);
        }
    } else {
        showNotification("Turn on mining mode first!", 2000);
    }
}

function enterShip() {
    if (player.resources.iron >= 50) {
        player.resources.iron -= 50;
        updateUI();
        showNotification("üöÄ ENTERING SPACESHIP!\nFuel: 50 Iron\nNext: Build fleet!", 4000);
    } else {
        showNotification(`Need 50 Iron for ship!\nYou have: ${player.resources.iron} Iron`, 3000);
    }
}

function showBuildMenu() {
    showNotification(`
    üèóÔ∏è BUILDING SYSTEM:
    
    Available Constructions:
    
    ‚Ä¢ SCOUT SHIP - 50 Iron
    Fast exploration
    
    ‚Ä¢ CARGO SHIP - 100 Iron
    Resource transport
    
    ‚Ä¢ MINING STATION - 200 Iron
    Auto-mines nearby
    
    ‚Ä¢ DEFENSE TURRET - 80 Iron
    Base protection
    
    Keep mining to unlock more!
    `, 6000);
}

function showGalaxyMap() {
    showNotification(`
    üåå GALAXY PROGRESSION:
    
    Current: Terra Nova
    Resources: Iron, Volcanium
    
    Next Planets:
    ‚Ä¢ Pyros V - 500 Iron
    (Volcanium rich)
    
    ‚Ä¢ Cryos-7 - Level 5
    (Energy crystals)
    
    ‚Ä¢ Zephyr Prime - Level 10
    (Rare gases)
    
    Your Level: ${player.level}
    `, 7000);
}

function saveGame() {
    const saveData = {
        player: player,
        timestamp: Date.now()
    };
    localStorage.setItem('eternal_empire_save', JSON.stringify(saveData));
    showNotification("üíæ GAME SAVED!\nProgress stored.", 2000);
}

function loadGame() {
    const saved = localStorage.getItem('eternal_empire_save');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            player = { ...player, ...data.player };
            updateUI();
            return true;
        } catch (e) {
            console.log("No valid save found");
        }
    }
    return false;
}

// ======================
// STARTUP
// ======================
window.addEventListener('load', () => {
    console.log("Eternal Empire loaded!");
    
    // Pre-fill username
    document.getElementById('username').value = "SpaceCommander";
    
    // Auto-save every minute
    setInterval(saveGame, 60000);
    
    // Handle resize
    window.addEventListener('resize', () => {
        const canvas = document.getElementById('gameCanvas');
        if (canvas) {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
    });
});

// Add the missing OrbitControls if not available
if (typeof THREE !== 'undefined' && !THREE.OrbitControls) {
    console.log("OrbitControls not found, using simple camera");
}
</script>

</body>
</html>
